<!DOCTYPE html>
<html lang="en">

<head>
	<title>MyA-Fib</title>

	
	<!-- Specify a stylesheet -->

	<link rel="stylesheet" href="css/default.css" title="style" media="screen" type="text/css" />

	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	
	<script type="text/javascript" src="js/jquery-3.0.0.min.js"></script>
	<script type="text/javascript" src="js/jquery.color-2.1.2.min.js"></script>
	<script type="text/javascript" src="js/jquery.validate.min.js"></script>
	<script type="text/javascript" src="js/functions.js"></script>
	
	
	<script type="text/javascript">
	
	var validation = {
	//validation object
		isValid: true,
		errorCount: 0,
		groupErrorCount: 0,
		checkIfNotEmpty: function(inputText) {
			if (inputText.length > 0) {
				return true;
			} else {
				return false;
			}
		},		
		validateEmail: function(inputText) {
			var emailFormat = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
			if(inputText.match(emailFormat)) {
				return true;
			} else { 
				//console.log("You have entered an invalid email address!");
			return false;
			}
		},
		validatePassword: function(inputText) {
			// (?=.*\d) for at least one digit
			// (?=.*[a-zA-Z]) for at least one letter
			// (?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]) for at least one special character
			// {6,20} for 6-20 characters in length
			var passwordFormat = /^(?=.*\d)(?=.*[a-zA-Z])(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{6,20}$/;
			if(inputText.match(passwordFormat)) {
				return true;
			} else { 
				//console.log("You have entered an invalid password!");
				return false;
			}
		},
		validate: function(elementID, validationType, returnIsValid) {
			this.isValid = true;
			this.errorCount = 0;
			var inputValue = document.getElementById(elementID).value;
			if (validationType == "email") {
				if (this.checkIfNotEmpty(inputValue)) {
					//console.log("Email contains something");
					if (this.validateEmail(inputValue)) {
						//console.log("Email is a valid email");
						document.getElementById(elementID+"Error").style.display = "none";
					} else {
						//console.log("Email is NOT valid email");
						this.errorCount ++;
						this.displayError(elementID, "Please enter a valid email address (ex. jim@company.com)");
					}
				} else {
					//console.log("Email field is empty");
					this.displayError(elementID, "Please enter your email address");
					this.errorCount ++;
				}
			} else if (validationType == "password") {
				if (this.checkIfNotEmpty(inputValue)) {
					//console.log("password contains something");
					if (this.validatePassword(inputValue)) {
						//console.log("Password is a valid email");
						document.getElementById(elementID+"Error").style.display = "none";
					} else {
						//console.log("Password is NOT valid password");
						this.errorCount ++;
						this.displayError(elementID, "Your password must contain at least one number, uppercase letter, lowercase letter, a special character, and be 6-20 characters long.");
					}
				} else {
					//console.log("Email field is empty");
					this.displayError(elementID, "Please enter your password");
					this.errorCount ++;
				}
			} else {
				console.log("Unknown validation type");
				this.errorCount ++;
			}
			
			if (this.errorCount > 0) { this.isValid = false; } else { this.isValid = true; }
			
			if (returnIsValid == true) { //optional parameter to return whether or not item is valid
				return this.isValid;
			}
			
		}, validateGroup: function(group, returnIsValid) {
			//key is ID and group[key] is validationType
			//ex. an array like {'emailfield':'email', 'passwordfield','password'}
			this.groupErrorCount = 0;
			
			for (var key in group) {
				if (!group.hasOwnProperty(key)) continue;
				this.validate(key,group[key]);
				this.groupErrorCount = this.groupErrorCount + this.errorCount;
				//console.log("["+key+"] => "+group[key]);
			}
			
			if (this.groupErrorCount > 0) { this.isValid = false; } else { this.isValid = true; }
			
			if (returnIsValid == true) { //optional parameter to return whether or not item is valid
				return this.isValid;
			}		

		}, displayError: function(elementID, errorText) {
			reference = "#" + elementID + "Error";
			//Create a reference to the corresponding hidden error div by using the ID of the input element and appending "Error"
			$(reference).html(errorText);
				if ($(reference).css('display') == "none") {
					$(reference).fadeIn();
				} else {
					//var initialColor = $(reference).css("background-color");
					var initialColor = "rgb(255, 189, 189)";
					$(reference)
					.animate({backgroundColor:'#FF6666'}, 100)
					.delay(100)
					.animate({backgroundColor:initialColor}, 100);
				}	
		
		}, displayMessage: function(messageText) {
			$("#message span").html(messageText);
		
			if ($("#message").css('display') == "none") {
				$("#message").fadeIn();
			} else {
				var initialColor = $("#message").css("background-color");
				$("#message")
				.animate({backgroundColor:'#FF6666'}, 100)
				.delay(100)
				.animate({backgroundColor:initialColor}, 100);
			}	
		
	}
	};
	
	 
	
	
	$(document).ready(function() {
	
	$("#email").blur(function() {validation.validate("email", "email")});
	$("#password").blur(function() {validation.validate("password", "password")});
	
		$("#submit").click(function(){
			
			var dataSent = { //id, value, type
				"1": ["email", $("#email").val(), "email"],
				"2": ["password", $("#password").val(), "password"]
			};
			
			
			if(validation.validateGroup({"email":"email","password":"password"},true)) {//If no errors, proceed with form submission 
				//console.log(dataSent);
				
				$.ajax({
				type: "POST",
				url: "http://medicineinnovation.com/myafib/processor.php",
				//contentType: 'application/json; charset=UTF-8',
				data: dataSent,
				dataType: 'json',
				crossDomain: true,
				cache: false,
				beforeSend: function(){ $("#submit").val('Connecting...');},
				success: function(dataReceived){
					$("#submit").val('Log in');
					
					//console.log(dataReceived);
					
					if (typeof dataReceived["fieldErrorMessages"] != "undefined") { //display error messages related to text fields
						for (var key in dataReceived["fieldErrorMessages"]) {
							validation.displayError(key,dataReceived["fieldErrorMessages"][key]);
						}
					}
					
						for (var key in dataSent) {//hide error messages if they are currently shown
							//console.log(dataSent[key][2]+":"+dataReceived["fieldErrorMessages"][dataSent[key][2]]);
							if (typeof dataReceived["fieldErrorMessages"] == "undefined") {
								document.getElementById(dataSent[key][2]+"Error").style.display = "none";
							} else if (typeof dataReceived["fieldErrorMessages"][dataSent[key][2]] == "undefined") {
								document.getElementById(dataSent[key][2]+"Error").style.display = "none";
							}
						}
						
					if (typeof dataReceived["topMessage"] != "undefined") { //display message returned from server
						validation.displayMessage(dataReceived["topMessage"]);
					} else { //hide it if there is no message to display
						document.getElementById('message').style.display = "none";
					} 
					
					if (dataReceived["authenticated"] == true) {
						localStorage.loggedIn = 1;
						$("#submit").val('Logged in');
						window.location.href="index.html";
					}
					
					
					
				}
				});
			} else { return false; //there are validation errors
			} return false;
		});
			
	});
	
	</script>
	
	<!--
	<meta name="viewport" content="width=device-width, initial-scale=2.0">
	-->
	<link rel="icon" href="img/favicon-16x16.png">

	
<!-- if browser is IE < version 9, teach it about new HTML5 elements -->
<!--[if lt IE 9]>
<script>
  var e = ("abbr,article,aside,audio,canvas,datalist,details," +
    "figure,footer,header,hgroup,mark,menu,meter,nav,output," +
    "progress,section,time,video").split(',');
  for (var i = 0; i < e.length; i++) {
    document.createElement(e[i]);
  }
</script>
<![endif]-->
</head>

<div class="main">

	<img src ="img/logo.png" />

	
	<form id="login">
		<h1>Log in</h1>
		
		<div class="formMain">
			
			<div id="message">
				<h2>Error</h2>
				<span></span>
			</div>
			
			<div class="errorBubble" id="emailError">Please enter a valid email address</div>
			<h2>Email</h2><input type="text" id="email" autofocus  /><br />
			<div class="errorBubble" id="passwordError">Please enter a valid password</div>
			<h2>Password</h2><input type="password" id="password" autocomplete="off" />
			<input type="submit" id="submit" value="Log in" />
		</div>
	</form>

	<br />
	<span style="color: #c5411e;">
Copyright &copy; <script>document.write(new Date().getFullYear())</script> Mark Tuttle MD.  All rights reserved.
</span>

</div>


</body>

</html>